{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the CineStream application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "User's phone number."
        },
        "signUpDate": {
          "type": "string",
          "description": "Date and time the user signed up.",
          "format": "date-time"
        },
        "subscriptionIds": {
          "type": "array",
          "description": "References to Subscriptions. (Relationship: User 1:N Subscription)",
          "items": {
            "type": "string"
          }
        },
        "tokenPurchaseHistoryIds": {
          "type": "array",
          "description": "References to TokenPurchaseHistory entries. (Relationship: User 1:N TokenPurchaseHistory)",
          "items": {
            "type": "string"
          }
        },
        "serviceTokenHistoryIds": {
          "type": "array",
          "description": "References to ServiceTokenHistory entries. (Relationship: User 1:N ServiceTokenHistory)",
          "items": {
            "type": "string"
          }
        },
        "changeLog": {
          "type": "array",
          "description": "History of changes made to the user's information.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "signUpDate"
      ]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category in the CineStream application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the category entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the category."
        },
        "slug": {
          "type": "string",
          "description": "Slug for the category (used in URLs)."
        },
        "parentId": {
          "type": "string",
          "description": "Reference to parent Category. Null if it's a top-level category. (Relationship: Category 1:N Category)"
        }
      },
      "required": [
        "id",
        "name",
        "slug"
      ]
    },
    "Video": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Video",
      "type": "object",
      "description": "Represents a video in the CineStream application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the video entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the video."
        },
        "description": {
          "type": "string",
          "description": "Description of the video."
        },
        "instructor": {
          "type": "string",
          "description": "Name of the instructor."
        },
        "duration": {
          "type": "number",
          "description": "Duration of the video in seconds."
        },
        "categoryId": {
          "type": "string",
          "description": "Reference to Category. (Relationship: Category 1:N Video)"
        },
        "videoUrl": {
          "type": "string",
          "description": "URL of the video file.",
          "format": "uri"
        },
        "thumbnailUrl": {
          "type": "string",
          "description": "URL of the video thumbnail image.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "title",
        "categoryId",
        "videoUrl",
        "thumbnailUrl"
      ]
    },
    "VideoLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "VideoLog",
      "type": "object",
      "description": "Represents a user's video viewing history.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the video log entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N VideoLog)"
        },
        "videoId": {
          "type": "string",
          "description": "Reference to Video. (Relationship: Video 1:N VideoLog)"
        },
        "watchDate": {
          "type": "string",
          "description": "Date and time the video was watched.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "videoId",
        "watchDate"
      ]
    },
    "Pricing": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Pricing",
      "type": "object",
      "description": "Represents the pricing information for subscriptions and token packages.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the pricing entity.  This will likely only have one record in the database."
        },
        "subscriptionPrices": {
          "type": "array",
          "description": "Array of subscription prices with duration.",
          "items": {
            "type": "string"
          }
        },
        "tokenPackagePrices": {
          "type": "array",
          "description": "Array of token package prices.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id"
      ]
    },
    "Subscription": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Subscription",
      "type": "object",
      "description": "Represents a user's subscription.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the subscription entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Subscription)"
        },
        "startDate": {
          "type": "string",
          "description": "Start date of the subscription.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "End date of the subscription.",
          "format": "date-time"
        },
        "pricingId": {
          "type": "string",
          "description": "Reference to Pricing. (Relationship: Pricing 1:N Subscription).  Determines pricing."
        }
      },
      "required": [
        "id",
        "userId",
        "startDate",
        "endDate",
        "pricingId"
      ]
    },
    "TokenPurchaseHistory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TokenPurchaseHistory",
      "type": "object",
      "description": "Represents a user's token purchase history.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the token purchase history entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N TokenPurchaseHistory)"
        },
        "purchaseDate": {
          "type": "string",
          "description": "Date and time the tokens were purchased.",
          "format": "date-time"
        },
        "tokensPurchased": {
          "type": "number",
          "description": "Number of tokens purchased."
        },
        "pricingId": {
          "type": "string",
          "description": "Reference to Pricing. (Relationship: Pricing 1:N TokenPurchaseHistory). Determines pricing."
        }
      },
      "required": [
        "id",
        "userId",
        "purchaseDate",
        "tokensPurchased",
        "pricingId"
      ]
    },
    "ServiceTokenHistory": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ServiceTokenHistory",
      "type": "object",
      "description": "Represents a record of tokens given to a user by an administrator.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the service token history entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N ServiceTokenHistory)"
        },
        "grantDate": {
          "type": "string",
          "description": "Date and time the tokens were granted.",
          "format": "date-time"
        },
        "tokensGranted": {
          "type": "number",
          "description": "Number of tokens granted."
        },
        "adminId": {
          "type": "string",
          "description": "Reference to Admin. (Relationship: Admin 1:N ServiceTokenHistory). Determines who granted tokens"
        }
      },
      "required": [
        "id",
        "userId",
        "grantDate",
        "tokensGranted",
        "adminId"
      ]
    },
    "Admin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Admin",
      "type": "object",
      "description": "Represents an administrator user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the administrator user."
        },
        "name": {
          "type": "string",
          "description": "Administrator's full name."
        },
        "email": {
          "type": "string",
          "description": "Administrator's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "Administrator's phone number."
        },
        "signUpDate": {
          "type": "string",
          "description": "Date and time the administrator signed up.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "signUpDate"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles. The userId parameter is the Firebase Auth UID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/categories/{categoryId}",
        "definition": {
          "entityName": "Category",
          "schema": {
            "$ref": "#/backend/entities/Category"
          },
          "description": "Stores category information, including hierarchical relationships. Includes parentId to manage the category tree.",
          "params": [
            {
              "name": "categoryId",
              "description": "The unique identifier for the category."
            }
          ]
        }
      },
      {
        "path": "/categories/{categoryId}/videos/{videoId}",
        "definition": {
          "entityName": "Video",
          "schema": {
            "$ref": "#/backend/entities/Video"
          },
          "description": "Stores video metadata, organized under categories.  This path allows for efficient retrieval of videos by category.",
          "params": [
            {
              "name": "categoryId",
              "description": "The unique identifier for the category."
            },
            {
              "name": "videoId",
              "description": "The unique identifier for the video."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/videoLogs/{videoLogId}",
        "definition": {
          "entityName": "VideoLog",
          "schema": {
            "$ref": "#/backend/entities/VideoLog"
          },
          "description": "Stores user's video viewing history. Includes userId and videoId for tracking.  Denormalized access control fields can be added here if necessary.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "videoLogId",
              "description": "The unique identifier for the video log entry."
            }
          ]
        }
      },
      {
        "path": "/settings/pricing",
        "definition": {
          "entityName": "Pricing",
          "schema": {
            "$ref": "#/backend/entities/Pricing"
          },
          "description": "Stores pricing information for subscriptions and token packages. This is a singleton document.",
          "params": []
        }
      },
      {
        "path": "/users/{userId}/subscriptions/{subscriptionId}",
        "definition": {
          "entityName": "Subscription",
          "schema": {
            "$ref": "#/backend/entities/Subscription"
          },
          "description": "Stores user subscription details.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "subscriptionId",
              "description": "The unique identifier for the subscription."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/tokenPurchaseHistory/{tokenPurchaseHistoryId}",
        "definition": {
          "entityName": "TokenPurchaseHistory",
          "schema": {
            "$ref": "#/backend/entities/TokenPurchaseHistory"
          },
          "description": "Stores user's token purchase history.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "tokenPurchaseHistoryId",
              "description": "The unique identifier for the token purchase history entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/serviceTokenHistory/{serviceTokenHistoryId}",
        "definition": {
          "entityName": "ServiceTokenHistory",
          "schema": {
            "$ref": "#/backend/entities/ServiceTokenHistory"
          },
          "description": "Stores history of tokens granted to users by administrators.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "serviceTokenHistoryId",
              "description": "The unique identifier for the service token history entry."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "Admin",
          "schema": {
            "$ref": "#/backend/entities/Admin"
          },
          "description": "Determines admin privileges. If a document exists for a userId in this collection, that user is an admin. Existence over content.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user who is an admin."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the CineStream application's features, focusing on authorization independence, clarity, and scalability. User-owned data and collaborative data patterns are applied consistently. Denormalization is used to avoid `get()` calls in security rules.\n\n*   **Authorization Independence**: The structure denormalizes authorization context where necessary. For instance, if access to `videoLogs` needs to be restricted based on user roles or video ownership, the relevant user and video details (like category) are copied into `videoLogs` documents. This eliminates the need for security rules to fetch parent document data, enabling atomic operations and improving security rule performance.\n\n*   **Structural Segregation**:  Data with different access requirements are stored in separate collections. For example, user-specific data resides under `/users/{userId}`, while global data like `/categories` is stored at the root level.\n\n*   **Access Modeling**: Path-based ownership is used for user-owned data (e.g., `/users/{userId}/subscriptions/{subscriptionId}`).  The membership map pattern isn't explicitly used here, as admin roles will be determined by document existence.  The nested data (e.g. subscriptions, token purchases) continue the path structure.\n\n*   **QAPs (Queryability And Performance)**: The data structure facilitates secure `list` operations.  For instance, listing videos within a specific category is directly supported by the `/categories/{categoryId}/videos/{videoId}` structure. Since authorization information is denormalized when needed, rules can efficiently validate read access without complex lookups.\n\n*   **Admin Role**: The existence of a document in `/roles_admin/{userId}` determines admin status, which aligns with the DBAC principle.\n\n*   **Invariants**: Timestamps and other critical data can be validated using security rules, ensuring data integrity. For example, the `startDate` and `endDate` in `Subscription` can be checked against the current time in rules."
  }
}